/*****************************************************************//**
 * @file   JoypadState.cpp
 * @brief  
 * 
 * @author 鈴木希海
 * @date   December 2021
 *********************************************************************/
#include "JoypadState.h"
#include <string>
#ifdef _DEBUG
#include <stdexcept>
#endif
#include "../Math/Arithmetic.h"

namespace AppFrame {
  namespace Application {

    JoypadState::JoypadState(const int id) : InputBase() {
      _id = id; // 接続数を識別番号に設定
      _press = XINPUT_STATE();
      _trigger = _press;
      _type = DeviceType::Joypad;
    }

    void JoypadState::Process() {
      auto old = _press;
      // 入力状態の取得
      if (!GetJoypadXInputState(_id, &_press)) {
#ifdef _DEBUG
        throw std::logic_error("識別IDが有効ではありません\n");
#endif
        _state = State::NonActive;
        return; // 取得失敗
      }
      // 各種トリガ情報の更新
      for (auto no = 0; auto&& button : _trigger.Buttons) {
        button = Trigger(_press.Buttons[no], old.Buttons[no]);
        ++no;
      }
      // トリガーボタンの更新
      _trigger.LeftTrigger = Trigger(_press.LeftTrigger, old.LeftTrigger);
      _trigger.RightTrigger = Trigger(_press.RightTrigger, old.RightTrigger);
      // 各種スティックの更新
      _trigger.ThumbLX = Trigger(_press.ThumbLX, old.ThumbLX);
      _trigger.ThumbLY = Trigger(_press.ThumbLY, old.ThumbLY);
      _trigger.ThumbRX = Trigger(_press.ThumbRX, old.ThumbRX);
      _trigger.ThumbRY = Trigger(_press.ThumbRY, old.ThumbRY);
    }

    bool JoypadState::GetButton(const int key, const bool type) const {
      // 範囲内に収まっているかの判定
      if (!Math::Arithmetic::IsRange(key, 0, 15)) {
        return false; // キーが不正
      }
      // フラグに応じて返す値を切り替える
      if (type) {
        return _press.Buttons[key]; // 押下情報を返す
      }
      return _trigger.Buttons[key]; // トリガ情報を返す
    }
  } // namespace Application
} // namespace AppFrame